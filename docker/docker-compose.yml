# Production docker-compose — integrates with Traefik reverse proxy.
#
# Usage on server:
#   cp docker/.env.example .env   # then fill in real values
#   docker compose -f docker/docker-compose.yml up -d
#
# Required env vars (set in .env):
#   IMAGE_TAG          – image tag built by build.sh  (default: latest)
#   TRAEFIK_NETWORK    – name of the external Traefik Docker network
#   TRAEFIK_HOST       – public hostname, e.g. drai.example.com
#   TRAEFIK_ENTRYPOINT – Traefik entrypoint name       (default: web)
#   SECRET_KEY         – Flask session secret key

networks:
  default:
    name: ${TRAEFIK_NETWORK:?TRAEFIK_NETWORK is required}
    external: true

services:
  drai-offline:
    image: drai-offline:${IMAGE_TAG:-latest}
    container_name: drai-offline
    restart: always

    volumes:
      # Uploads are user-generated; always mount from host
      - ./uploads:/app/uploads
      # Mount models/analysis externally if you want to update without
      # rebuilding the image. Comment these out to use the baked-in copies.
      # - ./models:/app/models
      # - ./analysis:/app/analysis

    env_file:
      - .env

    environment:
      - APP_PORT=5000
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-2}
      - GUNICORN_THREADS=${GUNICORN_THREADS:-4}

    extra_hosts:
      - "host.docker.internal:host-gateway"

    dns:
      - "8.8.8.8"
      - "8.8.4.4"
      - "1.1.1.1"
      - "1.0.0.1"

    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:5000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
      start_interval: 10s

    labels:
      - "traefik.enable=true"

      # ── HTTP router ──────────────────────────────────────────────────────
      - "traefik.http.routers.drai-offline.rule=Host(`${TRAEFIK_HOST:?TRAEFIK_HOST is required}`)"
      - "traefik.http.routers.drai-offline.entrypoints=${TRAEFIK_ENTRYPOINT:-web}"
      - "traefik.http.routers.drai-offline.service=drai-offline"

      # ── HTTPS router (uncomment if Traefik has a TLS entrypoint) ─────────
      # - "traefik.http.routers.drai-offline-https.rule=Host(`${TRAEFIK_HOST}`)"
      # - "traefik.http.routers.drai-offline-https.entrypoints=websecure"
      # - "traefik.http.routers.drai-offline-https.tls=true"
      # - "traefik.http.routers.drai-offline-https.tls.certresolver=letsencrypt"
      # - "traefik.http.routers.drai-offline-https.service=drai-offline"
      # Redirect HTTP → HTTPS
      # - "traefik.http.middlewares.drai-https-redirect.redirectscheme.scheme=https"
      # - "traefik.http.routers.drai-offline.middlewares=drai-https-redirect"

      # ── Backend service ───────────────────────────────────────────────────
      - "traefik.http.services.drai-offline.loadbalancer.server.port=5000"

      # ── Network hint for Traefik ──────────────────────────────────────────
      - "traefik.docker.network=${TRAEFIK_NETWORK}"
