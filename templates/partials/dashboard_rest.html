{# Rest of dashboard: controls + progress in one compact row.
   Button disabled state comes from server-side progress to avoid Alpine.js re-init issues after HTMX swap. #}
<script type="application/json" id="dashboard-tag-values">{{ tag_values | tojson }}</script>

{%- set _running = progress and progress.is_running and not progress.is_paused -%}
{%- set _paused  = progress and progress.is_paused -%}
{%- set _done    = progress and progress.is_complete -%}

{% if error %}
<div class="mt-3 rounded-lg border border-red-200 bg-red-50 px-4 py-2 text-sm text-red-800 dark:border-red-800 dark:bg-red-900/30 dark:text-red-200">
  {{ error }}
</div>
{% elif current_data %}
<div class="mt-3 flex flex-wrap items-center gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 shadow-sm dark:border-zinc-700 dark:bg-zinc-900">

  <!-- ── Simulation control buttons ─────────────────────────────── -->
  <div class="flex items-center gap-1.5">

    <!-- Start: enabled only when idle (not running, not paused) -->
    <button
      type="button"
      hx-post="/simulation/start" hx-swap="none" hx-trigger="click"
      hx-on::htmx:after-request="if(event.detail.successful){ window.dispatchEvent(new CustomEvent('simulation-started')); htmx.trigger('#dashboard-poll-trigger', 'htmx:trigger'); }"
      {% if _running or _paused %}disabled{% endif %}
      class="inline-flex items-center gap-1 rounded-lg px-3 py-1.5 text-xs font-medium text-white transition
             bg-emerald-600 hover:bg-emerald-700 disabled:cursor-not-allowed disabled:opacity-40
             dark:bg-emerald-700 dark:hover:bg-emerald-600"
    >
      <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
      Start
    </button>

    <!-- Pause / Resume — single toggle button -->
    {% if _paused %}
    <button
      type="button"
      hx-post="/simulation/resume" hx-swap="none" hx-trigger="click"
      hx-on::htmx:after-request="if(event.detail.successful){ window.dispatchEvent(new CustomEvent('simulation-resumed')); htmx.trigger('#dashboard-poll-trigger', 'htmx:trigger'); }"
      class="inline-flex items-center gap-1 rounded-lg px-3 py-1.5 text-xs font-medium text-white transition
             bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600"
    >
      <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
      Resume
    </button>
    {% else %}
    <button
      type="button"
      hx-post="/simulation/pause" hx-swap="none" hx-trigger="click"
      hx-on::htmx:after-request="if(event.detail.successful){ window.dispatchEvent(new CustomEvent('simulation-paused')); htmx.trigger('#dashboard-poll-trigger', 'htmx:trigger'); }"
      {% if not _running %}disabled{% endif %}
      class="inline-flex items-center gap-1 rounded-lg px-3 py-1.5 text-xs font-medium text-white transition
             bg-amber-500 hover:bg-amber-600 disabled:cursor-not-allowed disabled:opacity-40
             dark:bg-amber-600 dark:hover:bg-amber-500"
    >
      <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
      Pause
    </button>
    {% endif %}

    <!-- Reset: always enabled -->
    <button
      type="button"
      hx-post="/simulation/reset" hx-swap="none" hx-trigger="click"
      hx-on::htmx:after-request="if(event.detail.successful){ window.dispatchEvent(new CustomEvent('simulation-reset')); htmx.trigger('#dashboard-poll-trigger', 'htmx:trigger'); }"
      class="inline-flex items-center gap-1 rounded-lg px-3 py-1.5 text-xs font-medium text-white transition
             bg-slate-500 hover:bg-slate-600 dark:bg-zinc-600 dark:hover:bg-zinc-500"
    >
      <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/></svg>
      Reset
    </button>
  </div>

  <!-- ── Divider ─────────────────────────────────────────────────── -->
  <div class="hidden h-6 w-px bg-slate-200 dark:bg-zinc-700 sm:block"></div>

  <!-- ── Status badge ───────────────────────────────────────────── -->
  {% if progress %}
  <span class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs font-medium
    {% if _done %}bg-slate-100 text-slate-600 dark:bg-zinc-700 dark:text-zinc-400
    {% elif _paused %}bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300
    {% elif _running %}bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300
    {% else %}bg-slate-100 text-slate-500 dark:bg-zinc-800 dark:text-zinc-400{% endif %}">
    <span class="h-1.5 w-1.5 rounded-full
      {% if _done %}bg-slate-400
      {% elif _paused %}bg-amber-500 animate-pulse
      {% elif _running %}bg-emerald-500 animate-pulse
      {% else %}bg-slate-400{% endif %}"></span>
    {% if _done %}Done{% elif _paused %}Paused{% elif _running %}Running{% else %}Ready{% endif %}
  </span>
  {% endif %}

  <!-- ── Progress bar ───────────────────────────────────────────── -->
  {% if progress %}
  {%- set prog_current = progress.current_index -%}
  {%- set prog_total   = progress.total_rows -%}
  {%- set prog_percent = progress.progress_percent -%}
  <div class="flex min-w-0 flex-1 items-center gap-2">
    <div class="h-1.5 min-w-[80px] flex-1 overflow-hidden rounded-full bg-slate-200 dark:bg-zinc-700">
      <div class="h-full rounded-full bg-blue-500 transition-all duration-500 dark:bg-blue-400" style="width: {{ prog_percent }}%"></div>
    </div>
    <span class="shrink-0 tabular-nums text-xs text-slate-500 dark:text-zinc-400">{{ prog_current }}&thinsp;/&thinsp;{{ prog_total }}</span>
  </div>
  {% endif %}

</div>
{% else %}
<div class="mt-3 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-center text-sm text-slate-500 dark:border-zinc-700 dark:bg-zinc-900 dark:text-zinc-400">
  Waiting for simulation to start…
</div>
{% endif %}
