{# Advanced Analytics & Prediction Panel — below SVG, ApexCharts MD/C subplots + KPI cards #}
<section id="analytics-panel" class="mt-6 w-full rounded-xl border border-slate-200 bg-white shadow-sm dark:border-zinc-600 dark:bg-zinc-900" aria-label="Advanced Analytics & Prediction">
  <div class="border-b border-slate-200 px-4 py-3 dark:border-zinc-700">
    <h2 class="text-lg font-semibold text-slate-800 dark:text-zinc-100">Advanced Analytics &amp; Prediction</h2>
    <p class="mt-0.5 text-xs text-slate-500 dark:text-zinc-400">ML predictions vs. laboratory data — sliding 17-point window (past 8, current, future 8)</p>
  </div>

  {# KPI Cards — Future horizon MAE (h1..h8) #}
  <div class="grid grid-cols-1 gap-3 px-4 py-3 sm:grid-cols-2">
    <div class="rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 dark:border-zinc-600 dark:bg-zinc-800">
      <p class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-zinc-400">MD (Metallization) Overall MAE</p>
      <p id="kpi-md-mae" class="mt-1 text-2xl font-bold tabular-nums text-slate-800 dark:text-zinc-100">—</p>
      <p class="text-xs text-slate-500 dark:text-zinc-400">Future window (h1 to h8)</p>
    </div>
    <div class="rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 dark:border-zinc-600 dark:bg-zinc-800">
      <p class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-zinc-400">Carbon Overall MAE</p>
      <p id="kpi-c-mae" class="mt-1 text-2xl font-bold tabular-nums text-slate-800 dark:text-zinc-100">—</p>
      <p class="text-xs text-slate-500 dark:text-zinc-400">Future window (h1 to h8)</p>
    </div>
  </div>

  {# MD Section — separate scale ~85–100 #}
  <div class="border-t border-slate-200 px-4 pb-4 pt-3 dark:border-zinc-700">
    <h3 class="mb-3 text-sm font-semibold text-slate-700 dark:text-zinc-300">MD (Metallization Degree)</h3>
    <div class="grid grid-cols-1 gap-2">
      <div id="chart-md-main" class="w-full" style="height: 280px;"></div>
      <div id="chart-md-error" class="w-full" style="height: 120px;"></div>
    </div>
  </div>

  {# C Section — separate scale ~0–5 #}
  <div class="border-t border-slate-200 px-4 pb-4 pt-3 dark:border-zinc-700">
    <h3 class="mb-3 text-sm font-semibold text-slate-700 dark:text-zinc-300">C (Carbon)</h3>
    <div class="grid grid-cols-1 gap-2">
      <div id="chart-c-main" class="w-full" style="height: 280px;"></div>
      <div id="chart-c-error" class="w-full" style="height: 120px;"></div>
    </div>
  </div>
</section>

<script>
(function() {
  'use strict';

  var isDark = document.documentElement.classList.contains('dark');
  var gridColor = isDark ? '#3f3f46' : '#e2e8f0';
  var textColor = isDark ? '#e4e4e7' : '#475569';
  var tooltipBg = isDark ? '#27272a' : '#ffffff';
  var tooltipBorder = isDark ? '#52525b' : '#e2e8f0';

  // Last received 17-point data for tooltip lookups
  var lastDataArray = [];

  function themeColors() {
    isDark = document.documentElement.classList.contains('dark');
    gridColor = isDark ? '#3f3f46' : '#e2e8f0';
    textColor = isDark ? '#e4e4e7' : '#475569';
    tooltipBg = isDark ? '#27272a' : '#ffffff';
    tooltipBorder = isDark ? '#52525b' : '#e2e8f0';
  }

  function formatTime(ts) {
    if (ts == null || ts === '') return '—';
    if (typeof ts === 'string' && /^\d{2}:\d{2}$/.test(ts)) return ts;
    try {
      var d = new Date(ts);
      if (isNaN(d.getTime())) return String(ts).slice(0, 5) || '—';
      var h = d.getHours(), m = d.getMinutes();
      return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
    } catch (e) {
      return String(ts).slice(0, 5) || '—';
    }
  }

  function horizonLabel(i) {
    if (i >= 9 && i <= 16) return 'h' + (i - 8);
    return '';
  }

  var chartMdMain = null;
  var chartMdError = null;
  var chartCMain = null;
  var chartCError = null;

  function buildCategories(arr) {
    return (arr || []).map(function(p) {
      if (p && p.time_display) return p.time_display;
      return formatTime(p && p.timestamp);
    });
  }

  function initCharts() {
    themeColors();
    var categories = Array(17).fill('—');

    var baseChart = {
      chart: { fontFamily: 'inherit', toolbar: { show: false }, zoom: { enabled: false } },
      grid: { borderColor: gridColor, strokeDashArray: 2, xaxis: { lines: { show: true } }, yaxis: { lines: { show: true } } },
      xaxis: { categories: categories, labels: { style: { colors: textColor }, rotate: -45 }, tickAmount: 16, crosshairs: { show: true } },
      legend: { labels: { colors: textColor }, position: 'top', horizontalAlign: 'right' },
      tooltip: { theme: isDark ? 'dark' : 'light', shared: true, intersect: false }
    };

    // MD Main — line (predicted) + scatter (actual), Y 85–100. Sparse data: force markers so isolated points render.
    chartMdMain = new ApexCharts(document.querySelector('#chart-md-main'), {
      series: [
        { name: 'Predicted', type: 'line', data: [], color: '#2563eb' },
        { name: 'Actual', type: 'line', data: [], color: '#dc2626' }
      ],
      chart: Object.assign({}, baseChart.chart, { height: 280, group: 'md-group', animations: { enabled: true } }),
      stroke: { curve: 'straight', width: [2, 2] },
      markers: { size: 5, shape: 'circle', strokeWidth: 0, hover: { sizeOffset: 2 } },
      grid: baseChart.grid,
      xaxis: baseChart.xaxis,
      yaxis: { min: 85, max: 100, labels: { style: { colors: textColor } }, title: { text: 'MD (%)', style: { color: textColor } } },
      legend: baseChart.legend,
      tooltip: {
        theme: isDark ? 'dark' : 'light',
        shared: true,
        intersect: false,
        custom: function(opts) {
          var i = opts.dataPointIndex;
          var row = lastDataArray[i];
          var time = row ? formatTime(row.timestamp || row.time_display) : (opts.ctx.w.globals.labels[i] || '—');
          var hor = horizonLabel(i);
          var actual = row && row.actual_md != null ? Number(row.actual_md).toFixed(2) : '—';
          var pred = row && row.pred_md != null ? Number(row.pred_md).toFixed(2) : '—';
          var err = (row && row.actual_md != null && row.pred_md != null) ? Math.abs(row.actual_md - row.pred_md).toFixed(2) : '—';
          var line = 'Time: ' + time + (hor ? ' | Horizon: ' + hor : '') + ' | Actual: ' + actual + ' | Predicted: ' + pred + ' | Abs Error: ' + err;
          return '<div class="apex-tooltip apex-custom" style="padding:8px 12px;background:' + tooltipBg + ';border:1px solid ' + tooltipBorder + ';border-radius:6px;font-size:12px;color:' + textColor + '">' + line + '</div>';
        }
      }
    });
    chartMdMain.render();

    // MD Error — bars only for future 8 steps (h1..h8, indices 9–16). |Actual − Predicted|.
    chartMdError = new ApexCharts(document.querySelector('#chart-md-error'), {
      series: [{ name: 'Abs Error', type: 'column', data: [], color: '#64748b' }],
      chart: Object.assign({}, baseChart.chart, { height: 120, group: 'md-group', animations: { enabled: true } }),
      plotOptions: { bar: { columnWidth: '70%', distributed: false } },
      grid: baseChart.grid,
      xaxis: baseChart.xaxis,
      yaxis: {
        min: 0,
        labels: {
          style: { colors: textColor },
          formatter: function(value) { return value != null && !isNaN(value) ? Number(value).toFixed(3) : ''; }
        },
        title: { text: '|Actual − Predicted|', style: { color: textColor } }
      },
      legend: { show: false },
      tooltip: {
        theme: isDark ? 'dark' : 'light',
        custom: function(opts) {
          var i = opts.dataPointIndex;
          var row = lastDataArray[i];
          var time = row ? formatTime(row.timestamp || row.time_display) : (opts.ctx.w.globals.labels[i] || '—');
          var hor = horizonLabel(i);
          var actual = row && row.actual_md != null ? Number(row.actual_md).toFixed(2) : '—';
          var pred = row && row.pred_md != null ? Number(row.pred_md).toFixed(2) : '—';
          var err = (row && row.actual_md != null && row.pred_md != null) ? Math.abs(row.actual_md - row.pred_md).toFixed(3) : '—';
          return '<div class="apex-tooltip apex-custom" style="padding:8px 12px;background:' + tooltipBg + ';border:1px solid ' + tooltipBorder + ';border-radius:6px;font-size:12px;color:' + textColor + '">Time: ' + time + (hor ? ' | Horizon: ' + hor : '') + ' | Actual: ' + actual + ' | Predicted: ' + pred + ' | Abs Error: ' + err + '</div>';
        }
      }
    });
    chartMdError.render();

    // C Main — line + scatter, Y 0–5. Sparse data: force markers so isolated points render.
    chartCMain = new ApexCharts(document.querySelector('#chart-c-main'), {
      series: [
        { name: 'Predicted', type: 'line', data: [], color: '#2563eb' },
        { name: 'Actual', type: 'line', data: [], color: '#dc2626' }
      ],
      chart: Object.assign({}, baseChart.chart, { height: 280, group: 'c-group', animations: { enabled: true } }),
      stroke: { curve: 'straight', width: [2, 2] },
      markers: { size: 5, shape: 'circle', strokeWidth: 0, hover: { sizeOffset: 2 } },
      grid: baseChart.grid,
      xaxis: baseChart.xaxis,
      yaxis: { min: 0, max: 5, labels: { style: { colors: textColor } }, title: { text: 'C (%)', style: { color: textColor } } },
      legend: baseChart.legend,
      tooltip: {
        theme: isDark ? 'dark' : 'light',
        shared: true,
        intersect: false,
        custom: function(opts) {
          var i = opts.dataPointIndex;
          var row = lastDataArray[i];
          var time = row ? formatTime(row.timestamp || row.time_display) : (opts.ctx.w.globals.labels[i] || '—');
          var hor = horizonLabel(i);
          var actual = row && row.actual_c != null ? Number(row.actual_c).toFixed(2) : '—';
          var pred = row && row.pred_c != null ? Number(row.pred_c).toFixed(2) : '—';
          var err = (row && row.actual_c != null && row.pred_c != null) ? Math.abs(row.actual_c - row.pred_c).toFixed(2) : '—';
          return '<div class="apex-tooltip apex-custom" style="padding:8px 12px;background:' + tooltipBg + ';border:1px solid ' + tooltipBorder + ';border-radius:6px;font-size:12px;color:' + textColor + '">Time: ' + time + (hor ? ' | Horizon: ' + hor : '') + ' | Actual: ' + actual + ' | Predicted: ' + pred + ' | Abs Error: ' + err + '</div>';
        }
      }
    });
    chartCMain.render();

    // C Error — bars only for future 8 steps (h1..h8, indices 9–16).
    chartCError = new ApexCharts(document.querySelector('#chart-c-error'), {
      series: [{ name: 'Abs Error', type: 'column', data: [], color: '#64748b' }],
      chart: Object.assign({}, baseChart.chart, { height: 120, group: 'c-group', animations: { enabled: true } }),
      plotOptions: { bar: { columnWidth: '70%' } },
      grid: baseChart.grid,
      xaxis: baseChart.xaxis,
      yaxis: {
        min: 0,
        labels: {
          style: { colors: textColor },
          formatter: function(value) { return value != null && !isNaN(value) ? Number(value).toFixed(3) : ''; }
        },
        title: { text: '|Actual − Predicted|', style: { color: textColor } }
      },
      legend: { show: false },
      tooltip: {
        theme: isDark ? 'dark' : 'light',
        custom: function(opts) {
          var i = opts.dataPointIndex;
          var row = lastDataArray[i];
          var time = row ? formatTime(row.timestamp || row.time_display) : (opts.ctx.w.globals.labels[i] || '—');
          var hor = horizonLabel(i);
          var actual = row && row.actual_c != null ? Number(row.actual_c).toFixed(2) : '—';
          var pred = row && row.pred_c != null ? Number(row.pred_c).toFixed(2) : '—';
          var err = (row && row.actual_c != null && row.pred_c != null) ? Math.abs(row.actual_c - row.pred_c).toFixed(3) : '—';
          return '<div class="apex-tooltip apex-custom" style="padding:8px 12px;background:' + tooltipBg + ';border:1px solid ' + tooltipBorder + ';border-radius:6px;font-size:12px;color:' + textColor + '">Time: ' + time + (hor ? ' | Horizon: ' + hor : '') + ' | Actual: ' + actual + ' | Predicted: ' + pred + ' | Abs Error: ' + err + '</div>';
        }
      }
    });
    chartCError.render();
  }

  function safeNum(v) {
    if (v == null || v === undefined) return null;
    var n = Number(v);
    return (typeof n === 'number' && !isNaN(n)) ? n : null;
  }

  window.updateCharts = function(newDataArray) {
    if (!newDataArray || !Array.isArray(newDataArray)) return;
    var arr = newDataArray.slice();
    if (arr.length < 17) {
      while (arr.length < 17) arr.push({ timestamp: null, time_display: '—', actual_md: null, pred_md: null, actual_c: null, pred_c: null });
    }
    lastDataArray = arr;
    var categories = buildCategories(arr);
    while (categories.length < 17) categories.push('—');

    var actualMd = [], predMd = [], actualC = [], predC = [];
    for (var i = 0; i < 17; i++) {
      var p = arr[i] || {};
      actualMd.push(safeNum(p.actual_md));
      predMd.push(safeNum(p.pred_md));
      actualC.push(safeNum(p.actual_c));
      predC.push(safeNum(p.pred_c));
    }

    var future_errors_md = [];
    var future_errors_c = [];
    var future_abs_chart_data_md = new Array(17).fill(null);
    var future_abs_chart_data_c = new Array(17).fill(null);
    for (var j = 9; j < 17; j++) {
      var actMd = actualMd[j];
      var predMdVal = predMd[j];
      if (actMd !== null && predMdVal !== null && !isNaN(actMd) && !isNaN(predMdVal)) {
        var errMd = Math.abs(actMd - predMdVal);
        future_errors_md.push(errMd);
        future_abs_chart_data_md[j] = parseFloat(errMd.toFixed(3));
      }
      var actC = actualC[j];
      var predCVal = predC[j];
      if (actC !== null && predCVal !== null && !isNaN(actC) && !isNaN(predCVal)) {
        var errC = Math.abs(actC - predCVal);
        future_errors_c.push(errC);
        future_abs_chart_data_c[j] = parseFloat(errC.toFixed(3));
      }
    }
    var maeMd = future_errors_md.length > 0
      ? (future_errors_md.reduce(function(a, b) { return a + b; }, 0) / future_errors_md.length).toFixed(3)
      : 'N/A (No Lab Data)';
    var maeC = future_errors_c.length > 0
      ? (future_errors_c.reduce(function(a, b) { return a + b; }, 0) / future_errors_c.length).toFixed(3)
      : 'N/A (No Lab Data)';

    console.log('Predicted MD:', predMd);
    console.log('Predicted C:', predC);

    if (chartMdMain) {
      chartMdMain.updateOptions({ xaxis: { categories: categories } });
      chartMdMain.updateSeries([{ data: predMd }, { data: actualMd }]);
    }
    if (chartMdError) {
      chartMdError.updateOptions({ xaxis: { categories: categories } });
      chartMdError.updateSeries([{ data: future_abs_chart_data_md }]);
    }
    if (chartCMain) {
      chartCMain.updateOptions({ xaxis: { categories: categories } });
      chartCMain.updateSeries([{ data: predC }, { data: actualC }]);
    }
    if (chartCError) {
      chartCError.updateOptions({ xaxis: { categories: categories } });
      chartCError.updateSeries([{ data: future_abs_chart_data_c }]);
    }
    if (typeof window.updateAnalyticsKpis === 'function') {
      window.updateAnalyticsKpis(maeMd, maeC);
    }
  };

  window.updateAnalyticsKpis = function(maeMd, maeC) {
    var elMd = document.getElementById('kpi-md-mae');
    var elC = document.getElementById('kpi-c-mae');
    var strMd = (maeMd != null && maeMd !== '') ? (typeof maeMd === 'string' && maeMd.indexOf('N/A') !== -1 ? maeMd : Number(maeMd).toFixed(3)) : '—';
    var strC = (maeC != null && maeC !== '') ? (typeof maeC === 'string' && maeC.indexOf('N/A') !== -1 ? maeC : Number(maeC).toFixed(3)) : '—';
    if (elMd) elMd.textContent = strMd;
    if (elC) elC.textContent = strC;
  };

  if (typeof ApexCharts !== 'undefined') {
    initCharts();
  } else {
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof ApexCharts !== 'undefined') initCharts();
    });
  }
})();
</script>
