<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DRAI Monitoring and Prediction Dashboard</title>
  <!-- Apply saved theme immediately to avoid flash -->
  <script>
    (function () {
      var stored = localStorage.getItem('drai-theme');
      var isDark = stored === null ? true : stored === 'dark';
      if (isDark) document.documentElement.classList.add('dark');
      else document.documentElement.classList.remove('dark');
    })();
  </script>
  <!-- HTMX for partial updates and control requests -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <!-- Local fallback: <script src="/static/vendor/htmx.min.js"></script> -->
  <script src="/static/vendor/tailwind.js"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <script src="/static/vendor/alpine.min.js" defer></script>
  <style>[x-cloak]{display:none !important}</style>
</head>
<body class="min-h-screen bg-slate-100 font-sans text-slate-800 dark:bg-zinc-900 dark:text-zinc-200">
  <!-- Theme toggle: subtle button, persisted in localStorage, default dark -->
  <div class="fixed top-4 right-4 z-50" x-data="themeToggle()" x-init="init()">
    <button
      type="button"
      @click="toggle()"
      aria-label="Toggle theme (light / dark)"
      class="rounded-lg p-2 text-slate-500 transition hover:bg-slate-200 hover:text-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-offset-2 dark:text-zinc-400 dark:hover:bg-zinc-700 dark:hover:text-zinc-200 dark:focus:ring-zinc-500 dark:focus:ring-offset-zinc-950"
    >
      <span x-show="isDark" aria-hidden="true" class="inline-block h-5 w-5">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364 2.636l-1.591 1.591M21 12h-2.25m-2.236 2.236l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
      </span>
      <span x-show="!isDark" x-cloak aria-hidden="true" class="inline-block h-5 w-5">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
      </span>
    </button>
  </div>
  <div
    id="app-root"
    class="mx-auto max-w-7xl px-4 pb-8"
    :class="currentPage === 'monitoring' ? '' : 'pt-8'"
    x-data="uploadForm()"
    @simulation-started.window="simRunning = true; simPaused = false"
    @simulation-paused.window="simPaused = true"
    @simulation-resumed.window="simPaused = false"
    @simulation-reset.window="simRunning = false; simPaused = false"
  >
    <header class="mb-8 text-center" x-show="currentPage === 'upload'" x-transition>
      <h1 class="text-3xl font-bold text-slate-800 dark:text-zinc-100">DRAI Monitoring and Prediction Dashboard</h1>
      <p class="mt-2 text-slate-600 dark:text-zinc-400">Offline simulation system for furnace data processing and prediction</p>
      <p class="mt-1 text-sm text-slate-500 dark:text-zinc-500">You can upload multiple CSV files in batch</p>
    </header>

    <main class="space-y-6">
      <!-- Page 1: Upload & Preprocess -->
      <section class="rounded-2xl border-2 border-slate-300 bg-white p-6 shadow-sm dark:border-zinc-600 dark:bg-zinc-900" x-show="currentPage === 'upload'" x-transition>
        <h2 class="mb-4 text-xl font-semibold text-slate-800 dark:text-zinc-100">CSV File Upload (Batch)</h2>
        <form
          id="upload-form"
          x-ref="uploadForm"
          @submit.prevent="handleUpload"
          enctype="multipart/form-data"
          class="space-y-4"
        >
          <!-- Process Tags Files -->
          <div>
            <label class="mb-2 block text-sm font-medium text-slate-700 dark:text-zinc-300">
              Process Tags files (process sensor data)
              <span class="text-xs text-slate-500 dark:text-zinc-400">(you can select multiple files)</span>
            </label>
            <input
              type="file"
              name="process_files"
              accept=".csv,.xlsx"
              multiple
              x-ref="processFiles"
              @change="updateFileCount('process', $event)"
              class="block w-full text-sm text-slate-600 dark:text-zinc-300 file:ml-4 file:rounded-lg file:border-0 file:bg-slate-100 file:px-4 file:py-2 file:font-medium file:text-slate-700 hover:file:bg-slate-200 dark:file:bg-zinc-600 dark:file:text-zinc-200 dark:hover:file:bg-zinc-500"
            />
            <p x-show="fileCounts.process > 0" class="mt-1 text-xs text-slate-500 dark:text-zinc-400">
              <span x-text="fileCounts.process"></span> file(s) selected
            </p>
          </div>

          <!-- Pellet Data Files -->
          <div>
            <label class="mb-2 block text-sm font-medium text-slate-700 dark:text-zinc-300">
              Pellet Data files (input pellet lab data)
              <span class="text-xs text-slate-500 dark:text-zinc-400">(you can select multiple files)</span>
            </label>
            <input
              type="file"
              name="pellet_files"
              accept=".csv,.xlsx"
              multiple
              x-ref="pelletFiles"
              @change="updateFileCount('pellet', $event)"
              class="block w-full text-sm text-slate-600 dark:text-zinc-300 file:ml-4 file:rounded-lg file:border-0 file:bg-slate-100 file:px-4 file:py-2 file:font-medium file:text-slate-700 hover:file:bg-slate-200 dark:file:bg-zinc-600 dark:file:text-zinc-200 dark:hover:file:bg-zinc-500"
            />
            <p x-show="fileCounts.pellet > 0" class="mt-1 text-xs text-slate-500 dark:text-zinc-400">
              <span x-text="fileCounts.pellet"></span> file(s) selected
            </p>
          </div>

          <!-- MD/Quality Data Files -->
          <div>
            <label class="mb-2 block text-sm font-medium text-slate-700 dark:text-zinc-300">
              MD/Quality Data files (output quality data)
              <span class="text-xs text-slate-500 dark:text-zinc-400">(you can select multiple files)</span>
            </label>
            <input
              type="file"
              name="md_files"
              accept=".csv,.xlsx"
              multiple
              x-ref="mdFiles"
              @change="updateFileCount('md', $event)"
              class="block w-full text-sm text-slate-600 dark:text-zinc-300 file:ml-4 file:rounded-lg file:border-0 file:bg-slate-100 file:px-4 file:py-2 file:font-medium file:text-slate-700 hover:file:bg-slate-200 dark:file:bg-zinc-600 dark:file:text-zinc-200 dark:hover:file:bg-zinc-500"
            />
            <p x-show="fileCounts.md > 0" class="mt-1 text-xs text-slate-500 dark:text-zinc-400">
              <span x-text="fileCounts.md"></span> file(s) selected
            </p>
          </div>

          <!-- Model frequency (1h, 15T, 30T) -->
          <div>
            <label class="mb-2 block text-sm font-medium text-slate-700 dark:text-zinc-300">
              Prediction model interval (frequency)
            </label>
            <select
              name="model_frequency"
              class="block w-full max-w-xs rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500 dark:border-zinc-600 dark:bg-zinc-700 dark:text-zinc-200 dark:focus:border-zinc-500 dark:focus:ring-zinc-500"
            >
              <option value="30T">30 minutes (30T)</option>
              <option value="15T">15 minutes (15T)</option>
              <option value="1h">1 hour (1h)</option>
            </select>
            <p class="mt-1 text-xs text-slate-500 dark:text-zinc-400">MD and C models use this interval for prediction.</p>
          </div>

          <!-- Preprocess Button -->
          <button
            type="submit"
            :disabled="uploading || !hasFiles()"
            class="inline-flex items-center gap-2 rounded-xl bg-slate-800 px-6 py-3 font-medium text-white shadow-md transition hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 disabled:opacity-50 dark:bg-zinc-600 dark:hover:bg-zinc-500 dark:focus:ring-offset-zinc-800"
          >
            <span x-show="uploading" class="inline-block h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
            <span x-text="uploading ? 'Preprocessing...' : 'Preprocess'"></span>
          </button>

          <!-- Upload Status -->
          <div x-show="uploadMessage" class="rounded-lg p-3" :class="uploadSuccess ? 'bg-green-50 text-green-800 dark:bg-green-900/30 dark:text-green-200' : 'bg-red-50 text-red-800 dark:bg-red-900/30 dark:text-red-200'">
            <p x-text="uploadMessage"></p>
          </div>
        </form>
      </section>

      <!-- Page 2: SVG loads once (no refresh); rest (controls, status, time, predictions) polls every 2s -->
      <div x-show="currentPage === 'monitoring'" x-transition class="min-h-0">
        <div id="dashboard-svg-container" class="overflow-auto min-h-0" style="max-height: 85vh;"></div>
        <div id="dashboard-rest-container" class="mt-4 space-y-4">
          <p class="text-center text-slate-500 dark:text-zinc-400">Loading...</p>
        </div>
        <div id="dashboard-initial-trigger" hx-get="/update-dashboard" hx-trigger="load" hx-swap="none" class="contents" aria-hidden="true"></div>
        <div id="dashboard-poll-trigger" hx-get="/update-dashboard?partial=rest" hx-trigger="every 2s" hx-swap="innerHTML" hx-target="#dashboard-rest-container" class="contents" aria-hidden="true"></div>
      </div>
    </main>
  </div>

  <script>
    // Theme toggle: default dark, persisted in localStorage
    function themeToggle() {
      return {
        isDark: true,
        init() {
          this.isDark = document.documentElement.classList.contains('dark');
        },
        toggle() {
          this.isDark = !this.isDark;
          if (this.isDark) {
            document.documentElement.classList.add('dark');
            localStorage.setItem('drai-theme', 'dark');
          } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('drai-theme', 'light');
          }
        }
      };
    }

    function uploadForm() {
      return {
        uploading: false,
        uploadMessage: '',
        uploadSuccess: false,
        dataLoaded: false,
        currentPage: 'upload', // 'upload' | 'monitoring'
        simRunning: false,
        simPaused: false,
        fileCounts: {
          process: 0,
          pellet: 0,
          md: 0
        },

        updateFileCount(type, event) {
          const files = event.target.files;
          this.fileCounts[type] = files ? files.length : 0;
        },

        hasFiles() {
          return this.fileCounts.process > 0 && this.fileCounts.pellet > 0 && this.fileCounts.md > 0;
        },

        async handleUpload() {
          this.uploading = true;
          this.uploadMessage = '';

          // Validate files before upload
          const processFiles = this.$refs.processFiles.files;
          const pelletFiles = this.$refs.pelletFiles.files;
          const mdFiles = this.$refs.mdFiles.files;
          
          if (processFiles.length === 0) {
            this.uploadMessage = 'Please select at least one Process Tags file.';
            this.uploadSuccess = false;
            this.uploading = false;
            return;
          }
          
          if (pelletFiles.length === 0) {
            this.uploadMessage = 'Please select at least one Pellet file.';
            this.uploadSuccess = false;
            this.uploading = false;
            return;
          }
          
          if (mdFiles.length === 0) {
            this.uploadMessage = 'Please select at least one MD/Quality file.';
            this.uploadSuccess = false;
            this.uploading = false;
            return;
          }

          const formData = new FormData();
          
          // Append all process files
          for (let i = 0; i < processFiles.length; i++) {
            formData.append('process_files', processFiles[i]);
          }
          
          // Append all pellet files
          for (let i = 0; i < pelletFiles.length; i++) {
            formData.append('pellet_files', pelletFiles[i]);
          }
          
          // Append all MD files
          for (let i = 0; i < mdFiles.length; i++) {
            formData.append('md_files', mdFiles[i]);
          }

          const freqSelect = this.$refs.uploadForm.querySelector('select[name="model_frequency"]');
          if (freqSelect) formData.append('model_frequency', freqSelect.value);
          
          // Debug log
          console.log(`Uploading: ${processFiles.length} process, ${pelletFiles.length} pellet, ${mdFiles.length} md files`);

          try {
            const response = await fetch('/upload', {
              method: 'POST',
              body: formData
            });

            const result = await response.json();

            if (result.success) {
              this.uploadMessage = result.message;
              this.uploadSuccess = true;
              this.dataLoaded = true;
              this.currentPage = 'monitoring';
              // Trigger initial dashboard load once the monitoring page is visible
              this.$nextTick(() => {
                setTimeout(() => {
                  var el = document.getElementById('dashboard-initial-trigger');
                  if (el) htmx.trigger(el, 'htmx:trigger');
                }, 300);
              });
            } else {
              this.uploadMessage = result.error || 'Upload failed';
              this.uploadSuccess = false;
            }
          } catch (error) {
            this.uploadMessage = 'Server error: ' + error.message;
            this.uploadSuccess = false;
          } finally {
            this.uploading = false;
          }
        },

        async startSimulation() {
          try {
            const response = await fetch('/simulation/start', { method: 'POST' });
            const result = await response.json();
            if (result.success) {
              this.simRunning = true;
              this.simPaused = false;
              htmx.trigger('#dashboard', 'htmx:trigger');
            }
          } catch (error) {
            console.error('Error starting simulation:', error);
          }
        },

        async pauseSimulation() {
          try {
            const response = await fetch('/simulation/pause', { method: 'POST' });
            const result = await response.json();
            if (result.success) {
              this.simPaused = true;
            }
          } catch (error) {
            console.error('Error pausing simulation:', error);
          }
        },

        async resumeSimulation() {
          try {
            const response = await fetch('/simulation/resume', { method: 'POST' });
            const result = await response.json();
            if (result.success) {
              this.simPaused = false;
              htmx.trigger('#dashboard', 'htmx:trigger');
            }
          } catch (error) {
            console.error('Error resuming simulation:', error);
          }
        },

        async resetSimulation() {
          try {
            const response = await fetch('/simulation/reset', { method: 'POST' });
            const result = await response.json();
            if (result.success) {
              this.simRunning = false;
              this.simPaused = false;
              htmx.trigger('#dashboard', 'htmx:trigger');
            }
          } catch (error) {
            console.error('Error resetting simulation:', error);
          }
        }
      };
    }
  </script>
  <!-- Apply dashboard SVG tag values directly (SVG is inline in the same document) -->
  <script>
    function applyDashboardTagValues() {
      var dataEl = document.querySelector('#dashboard-tag-values');
      if (!dataEl) return;
      var data = {};
      try { data = JSON.parse(dataEl.textContent); } catch (e) { return; }
      document.querySelectorAll('[id^="val__"]').forEach(function(el) {
        var tag = el.id.replace(/^val__/, '');
        var val = data[tag];
        if (val !== undefined && val !== null) {
          var tspan = el.querySelector('tspan');
          (tspan || el).textContent = String(val);
        }
      });
    }
    document.body.addEventListener('htmx:afterSettle', function() { applyDashboardTagValues(); });
  </script>
</body>
</html>
