<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>داشبورد مانیتورینگ و پیش‌بینی DRAI</title>
  <!-- HTMX for partial updates and control requests -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <!-- Local fallback: <script src="/static/vendor/htmx.min.js"></script> -->
  <script src="/static/vendor/tailwind.js"></script>
  <script src="/static/vendor/alpine.min.js" defer></script>
</head>
<body class="min-h-screen bg-slate-100 font-sans text-slate-800">
  <div
    id="app-root"
    class="mx-auto max-w-7xl px-4 py-8"
    x-data="uploadForm()"
    @simulation-started.window="simRunning = true; simPaused = false"
    @simulation-paused.window="simPaused = true"
    @simulation-resumed.window="simPaused = false"
    @simulation-reset.window="simRunning = false; simPaused = false"
  >
    <header class="mb-8 text-center" x-show="currentPage === 'upload'" x-transition>
      <h1 class="text-3xl font-bold text-slate-800">داشبورد مانیتورینگ و پیش‌بینی DRAI</h1>
      <p class="mt-2 text-slate-600">سیستم شبیه‌سازی آفلاین برای پردازش و پیش‌بینی داده‌های کوره</p>
      <p class="mt-1 text-sm text-slate-500">می‌توانید چندین فایل CSV را به صورت دسته‌ای آپلود کنید</p>
    </header>

    <main class="space-y-6">
      <!-- Page 1: Upload & Preprocess -->
      <section class="rounded-2xl border-2 border-slate-300 bg-white p-6 shadow-sm" x-show="currentPage === 'upload'" x-transition>
        <h2 class="mb-4 text-xl font-semibold text-slate-800">آپلود فایل‌های CSV (دسته‌ای)</h2>
        <form
          id="upload-form"
          x-ref="uploadForm"
          @submit.prevent="handleUpload"
          enctype="multipart/form-data"
          class="space-y-4"
        >
          <!-- Process Tags Files -->
          <div>
            <label class="mb-2 block text-sm font-medium text-slate-700">
              فایل‌های Process Tags (داده‌های سنسورهای فرآیندی)
              <span class="text-xs text-slate-500">(می‌توانید چندین فایل را انتخاب کنید)</span>
            </label>
            <input
              type="file"
              name="process_files"
              accept=".csv,.xlsx"
              multiple
              x-ref="processFiles"
              @change="updateFileCount('process', $event)"
              class="block w-full text-sm text-slate-600 file:mr-4 file:rounded-lg file:border-0 file:bg-slate-100 file:px-4 file:py-2 file:font-medium file:text-slate-700 hover:file:bg-slate-200"
            />
            <p x-show="fileCounts.process > 0" class="mt-1 text-xs text-slate-500">
              <span x-text="fileCounts.process"></span> فایل انتخاب شده
            </p>
          </div>

          <!-- Pellet Data Files -->
          <div>
            <label class="mb-2 block text-sm font-medium text-slate-700">
              فایل‌های Pellet Data (داده‌های آزمایشگاهی ورودی گندله)
              <span class="text-xs text-slate-500">(می‌توانید چندین فایل را انتخاب کنید)</span>
            </label>
            <input
              type="file"
              name="pellet_files"
              accept=".csv,.xlsx"
              multiple
              x-ref="pelletFiles"
              @change="updateFileCount('pellet', $event)"
              class="block w-full text-sm text-slate-600 file:mr-4 file:rounded-lg file:border-0 file:bg-slate-100 file:px-4 file:py-2 file:font-medium file:text-slate-700 hover:file:bg-slate-200"
            />
            <p x-show="fileCounts.pellet > 0" class="mt-1 text-xs text-slate-500">
              <span x-text="fileCounts.pellet"></span> فایل انتخاب شده
            </p>
          </div>

          <!-- MD/Quality Data Files -->
          <div>
            <label class="mb-2 block text-sm font-medium text-slate-700">
              فایل‌های MD/Quality Data (داده‌های کیفی خروجی)
              <span class="text-xs text-slate-500">(می‌توانید چندین فایل را انتخاب کنید)</span>
            </label>
            <input
              type="file"
              name="md_files"
              accept=".csv,.xlsx"
              multiple
              x-ref="mdFiles"
              @change="updateFileCount('md', $event)"
              class="block w-full text-sm text-slate-600 file:mr-4 file:rounded-lg file:border-0 file:bg-slate-100 file:px-4 file:py-2 file:font-medium file:text-slate-700 hover:file:bg-slate-200"
            />
            <p x-show="fileCounts.md > 0" class="mt-1 text-xs text-slate-500">
              <span x-text="fileCounts.md"></span> فایل انتخاب شده
            </p>
          </div>

          <!-- Model frequency (1h, 15T, 30T) -->
          <div>
            <label class="mb-2 block text-sm font-medium text-slate-700">
              بازهٔ مدل پیش‌بینی (فرکانس)
            </label>
            <select
              name="model_frequency"
              class="block w-full max-w-xs rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
            >
              <option value="30T">۳۰ دقیقه (30T)</option>
              <option value="15T">۱۵ دقیقه (15T)</option>
              <option value="1h">۱ ساعت (1h)</option>
            </select>
            <p class="mt-1 text-xs text-slate-500">مدل‌های MD و C بر اساس همین بازه برای پیش‌بینی استفاده می‌شوند.</p>
          </div>

          <!-- Preprocess Button -->
          <button
            type="submit"
            :disabled="uploading || !hasFiles()"
            class="inline-flex items-center gap-2 rounded-xl bg-slate-800 px-6 py-3 font-medium text-white shadow-md transition hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 disabled:opacity-50"
          >
            <span x-show="uploading" class="inline-block h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
            <span x-text="uploading ? 'در حال پیش‌پردازش...' : 'پیش‌پردازش'"></span>
          </button>

          <!-- Upload Status -->
          <div x-show="uploadMessage" class="rounded-lg p-3" :class="uploadSuccess ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'">
            <p x-text="uploadMessage"></p>
          </div>
        </form>
      </section>

      <!-- Page 2: SVG loads once (no refresh); rest (controls, status, time, predictions) polls every 2s -->
      <div x-show="currentPage === 'monitoring'" x-transition class="min-h-0">
        <div id="dashboard-svg-container" class="overflow-auto min-h-0" style="max-height: 85vh;"></div>
        <div id="dashboard-rest-container" class="mt-4 space-y-4">
          <p class="text-center text-slate-500">در حال بارگذاری...</p>
        </div>
        <div id="dashboard-initial-trigger" hx-get="/update-dashboard" hx-trigger="load" hx-swap="none" class="contents" aria-hidden="true"></div>
        <div id="dashboard-poll-trigger" hx-get="/update-dashboard?partial=rest" hx-trigger="every 2s" hx-swap="innerHTML" hx-target="#dashboard-rest-container" class="contents" aria-hidden="true"></div>
      </div>
    </main>
  </div>

  <script>
    function uploadForm() {
      return {
        uploading: false,
        uploadMessage: '',
        uploadSuccess: false,
        dataLoaded: false,
        currentPage: 'upload', // 'upload' | 'monitoring'
        simRunning: false,
        simPaused: false,
        fileCounts: {
          process: 0,
          pellet: 0,
          md: 0
        },

        updateFileCount(type, event) {
          const files = event.target.files;
          this.fileCounts[type] = files ? files.length : 0;
        },

        hasFiles() {
          return this.fileCounts.process > 0 && this.fileCounts.pellet > 0 && this.fileCounts.md > 0;
        },

        async handleUpload() {
          this.uploading = true;
          this.uploadMessage = '';

          // Validate files before upload
          const processFiles = this.$refs.processFiles.files;
          const pelletFiles = this.$refs.pelletFiles.files;
          const mdFiles = this.$refs.mdFiles.files;
          
          if (processFiles.length === 0) {
            this.uploadMessage = 'لطفاً حداقل یک فایل Process Tags انتخاب کنید.';
            this.uploadSuccess = false;
            this.uploading = false;
            return;
          }
          
          if (pelletFiles.length === 0) {
            this.uploadMessage = 'لطفاً حداقل یک فایل Pellet انتخاب کنید.';
            this.uploadSuccess = false;
            this.uploading = false;
            return;
          }
          
          if (mdFiles.length === 0) {
            this.uploadMessage = 'لطفاً حداقل یک فایل MD/Quality انتخاب کنید.';
            this.uploadSuccess = false;
            this.uploading = false;
            return;
          }

          const formData = new FormData();
          
          // Append all process files
          for (let i = 0; i < processFiles.length; i++) {
            formData.append('process_files', processFiles[i]);
          }
          
          // Append all pellet files
          for (let i = 0; i < pelletFiles.length; i++) {
            formData.append('pellet_files', pelletFiles[i]);
          }
          
          // Append all MD files
          for (let i = 0; i < mdFiles.length; i++) {
            formData.append('md_files', mdFiles[i]);
          }

          const freqSelect = this.$refs.uploadForm.querySelector('select[name="model_frequency"]');
          if (freqSelect) formData.append('model_frequency', freqSelect.value);
          
          // Debug log
          console.log(`Uploading: ${processFiles.length} process, ${pelletFiles.length} pellet, ${mdFiles.length} md files`);

          try {
            const response = await fetch('/upload', {
              method: 'POST',
              body: formData
            });

            const result = await response.json();

            if (result.success) {
              this.uploadMessage = result.message;
              this.uploadSuccess = true;
              this.dataLoaded = true;
              this.currentPage = 'monitoring';
              // Trigger initial dashboard load once the monitoring page is visible
              this.$nextTick(() => {
                setTimeout(() => {
                  var el = document.getElementById('dashboard-initial-trigger');
                  if (el) htmx.trigger(el, 'htmx:trigger');
                }, 300);
              });
            } else {
              this.uploadMessage = result.error || 'خطا در آپلود';
              this.uploadSuccess = false;
            }
          } catch (error) {
            this.uploadMessage = 'خطا در ارتباط با سرور: ' + error.message;
            this.uploadSuccess = false;
          } finally {
            this.uploading = false;
          }
        },

        async startSimulation() {
          try {
            const response = await fetch('/simulation/start', { method: 'POST' });
            const result = await response.json();
            if (result.success) {
              this.simRunning = true;
              this.simPaused = false;
              htmx.trigger('#dashboard', 'htmx:trigger');
            }
          } catch (error) {
            console.error('Error starting simulation:', error);
          }
        },

        async pauseSimulation() {
          try {
            const response = await fetch('/simulation/pause', { method: 'POST' });
            const result = await response.json();
            if (result.success) {
              this.simPaused = true;
            }
          } catch (error) {
            console.error('Error pausing simulation:', error);
          }
        },

        async resumeSimulation() {
          try {
            const response = await fetch('/simulation/resume', { method: 'POST' });
            const result = await response.json();
            if (result.success) {
              this.simPaused = false;
              htmx.trigger('#dashboard', 'htmx:trigger');
            }
          } catch (error) {
            console.error('Error resuming simulation:', error);
          }
        },

        async resetSimulation() {
          try {
            const response = await fetch('/simulation/reset', { method: 'POST' });
            const result = await response.json();
            if (result.success) {
              this.simRunning = false;
              this.simPaused = false;
              htmx.trigger('#dashboard', 'htmx:trigger');
            }
          } catch (error) {
            console.error('Error resetting simulation:', error);
          }
        }
      };
    }
  </script>
  <!-- Apply dashboard SVG tag values: after rest swap (poll) or when SVG is in page (find tag values in rest or svg container) -->
  <script>
    function applyDashboardTagValues() {
      var obj = document.getElementById('dashboard-svg-object');
      if (!obj) return;
      var dataEl = document.getElementById('dashboard-rest-container');
      if (dataEl) dataEl = dataEl.querySelector('#dashboard-tag-values');
      if (!dataEl) dataEl = document.querySelector('#dashboard-svg-container #dashboard-tag-values');
      if (!dataEl) return;
      var data = {};
      try { data = JSON.parse(dataEl.textContent); } catch (e) { return; }
      function apply() {
        if (!obj.contentDocument) return;
        var svg = obj.contentDocument;
        var elements = svg.querySelectorAll('[id^="val__"]');
        elements.forEach(function(el) {
          var tag = el.id.replace(/^val__/, '');
          var val = data[tag];
          if (val !== undefined && val !== null) {
            var tspan = el.querySelector('tspan');
            (tspan || el).textContent = val;
          }
        });
      }
      obj.addEventListener('load', apply);
      if (obj.contentDocument) apply();
    }
    document.body.addEventListener('htmx:afterSettle', function() { applyDashboardTagValues(); });
  </script>
</body>
</html>
